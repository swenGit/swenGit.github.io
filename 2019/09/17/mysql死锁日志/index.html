<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.4.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="mysql死锁日志故事背景之前学索引时看了些锁相关的知识,了解一些X锁 GAP锁的概念,应用方面却是很匮乏,群里有人提问怎么看死锁日志,我也跟着学一下 这个是某同学提供的死锁日志">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql死锁日志">
<meta property="og:url" content="http://yoursite.com/2019/09/17/mysql死锁日志/index.html">
<meta property="og:site_name" content="lalala~">
<meta property="og:description" content="mysql死锁日志故事背景之前学索引时看了些锁相关的知识,了解一些X锁 GAP锁的概念,应用方面却是很匮乏,群里有人提问怎么看死锁日志,我也跟着学一下 这个是某同学提供的死锁日志">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/09/17/mysql死锁日志/t1.png">
<meta property="og:image" content="http://yoursite.com/2019/09/17/mysql死锁日志/t2.png">
<meta property="og:updated_time" content="2019-09-19T07:39:48.718Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mysql死锁日志">
<meta name="twitter:description" content="mysql死锁日志故事背景之前学索引时看了些锁相关的知识,了解一些X锁 GAP锁的概念,应用方面却是很匮乏,群里有人提问怎么看死锁日志,我也跟着学一下 这个是某同学提供的死锁日志">
<meta name="twitter:image" content="http://yoursite.com/2019/09/17/mysql死锁日志/t1.png">
  <link rel="canonical" href="http://yoursite.com/2019/09/17/mysql死锁日志/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>mysql死锁日志 | lalala~</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?dd1e5524be2b83762eb6a060ff1d5b1a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <div class="container use-motion">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lalala~</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
      <article itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block post">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/17/mysql死锁日志/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Swen">
      <meta itemprop="description" content="rain drop dida dida ~~~">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lalala~">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">mysql死锁日志

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-09-17 03:06:04" itemprop="dateCreated datePublished" datetime="2019-09-17T03:06:04+08:00">2019-09-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-09-19 15:39:48" itemprop="dateModified" datetime="2019-09-19T15:39:48+08:00">2019-09-19</time>
              </span>
            
          

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="mysql死锁日志"><a href="#mysql死锁日志" class="headerlink" title="mysql死锁日志"></a>mysql死锁日志</h4><h5 id="故事背景"><a href="#故事背景" class="headerlink" title="故事背景"></a>故事背景</h5><p>之前学索引时看了些锁相关的知识,了解一些X锁 GAP锁的概念,应用方面却是很匮乏,群里有人提问怎么看死锁日志,我也跟着学一下</p>
<p>这个是某同学提供的死锁日志</p>
<a id="more"></a>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">=====================================</span><br><span class="line">2019-09-16 17:43:04 7f406db81700 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 18 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv_master_thread loops: 1309847 srv_active, 0 srv_shutdown, 513054 srv_idle</span><br><span class="line">srv_master_thread log flush and writes: 1822900</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES </span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 13074562</span><br><span class="line">OS WAIT ARRAY INFO: signal count 56022563</span><br><span class="line">Mutex spin waits 227294434, rounds 196977073, OS waits 421212</span><br><span class="line">RW-shared spins 35152388, rounds 1669232785, OS waits 4831737</span><br><span class="line">RW-excl spins 44120304, rounds 1685857586, OS waits 6905114</span><br><span class="line">Spin rounds per wait: 0.87 mutex, 47.49 RW-shared, 38.21 RW-excl</span><br><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2019-09-16 16:53:03 7f3c499ef700</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 4777818, ACTIVE 0.901 sec fetching rows</span><br><span class="line">mysql tables in use 4, locked 4</span><br><span class="line">LOCK WAIT 3286 lock struct(s), heap size 407080, 38 row lock(s), undo log entries 27</span><br><span class="line">LOCK BLOCKING MySQL thread id: 1419752 block 1485642</span><br><span class="line">MySQL thread id 1485642, OS thread handle 0x7f3c558a5700, query id 121123229 192.168.120.9 jiaoyixian Searching rows for update</span><br><span class="line">UPDATE t_wating_shop</span><br><span class="line">		SET `status` = 0</span><br><span class="line">		 </span><br><span class="line">		 ,is_lack = 0</span><br><span class="line">		 </span><br><span class="line">	    WHERE user_id = 604 AND shop_id = 21228 AND ymd = &apos;2019-09-16&apos;</span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 44 page no 14204 n bits 704 index `idx_ymd` of table `vvic-pms`.`t_wating_shop` trx id 4777818 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 220 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 800000000018498a; asc       I ;;</span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 4777820, ACTIVE 2.502 sec fetching rows</span><br><span class="line">mysql tables in use 4, locked 3</span><br><span class="line">1212 lock struct(s), heap size 161320, 58 row lock(s), undo log entries 4</span><br><span class="line">MySQL thread id 1419752, OS thread handle 0x7f3c499ef700, query id 121123216 192.168.120.9 jiaoyixian preparing</span><br><span class="line">UPDATE t_wating_shop</span><br><span class="line">		SET `status` = 0</span><br><span class="line">		WHERE</span><br><span class="line">			user_id = 753</span><br><span class="line">			AND ymd = &apos;2019-09-16&apos;</span><br><span class="line">			AND shop_id IN (</span><br><span class="line">				SELECT</span><br><span class="line">					shop_id</span><br><span class="line">				FROM</span><br><span class="line">					t_bill</span><br><span class="line">				WHERE</span><br><span class="line">					batch_id IN </span><br><span class="line">					 (    </span><br><span class="line">				  		1568596310045  </span><br><span class="line">					 ,   </span><br><span class="line">				  		1568602984074  </span><br><span class="line">					 ,   </span><br><span class="line">				  		1568603935432  </span><br><span class="line">					 ,   </span><br><span class="line">				  		1568614766375  </span><br><span class="line">					 ) </span><br><span class="line">			)</span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 44 page no 14204 n bits 704 index `idx_ymd` of table `vvic-pms`.`t_wating_shop` trx id 4777820 lock_mode X locks rec but not gap</span><br><span class="line">Record lock, heap no 220 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 800000000018498a; asc       I ;;</span><br><span class="line"></span><br><span class="line">Record lock, heap no 282 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 80000000001849c8; asc       I ;;</span><br><span class="line"></span><br><span class="line">Record lock, heap no 399 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 8000000000184a3e; asc       J&gt;;;</span><br><span class="line"></span><br><span class="line">Record lock, heap no 447 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 8000000000184a6e; asc       Jn;;</span><br><span class="line"></span><br><span class="line">Record lock, heap no 486 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 8000000000184a95; asc       J ;;</span><br><span class="line"></span><br><span class="line">Record lock, heap no 541 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 8000000000184acd; asc       J ;;</span><br><span class="line"></span><br><span class="line">Record lock, heap no 604 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 8000000000184b0c; asc       K ;;</span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 44 page no 14206 n bits 704 index `idx_ymd` of table `vvic-pms`.`t_wating_shop` trx id 4777820 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 202 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 8000000000184e78; asc       Nx;;</span><br><span class="line"></span><br><span class="line">*** WE ROLL BACK TRANSACTION (2)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>看上去一头包,找到了 混日子 的公众号文章,对照着看下: </p>
<p><a href="https://mp.weixin.qq.com/s/KX0RoDzi1otedvgp9wWQRw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/KX0RoDzi1otedvgp9wWQRw</a></p>
<h5 id="要怎么看"><a href="#要怎么看" class="headerlink" title="要怎么看"></a>要怎么看</h5><p>先模拟一个死锁:</p>
<p>练习锁的时候创建过一张三国英雄表,直接用了,这个是表结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `hero` (</span><br><span class="line">  `number` int(11) NOT NULL,</span><br><span class="line">  `name` varchar(100) DEFAULT NULL,</span><br><span class="line">  `country` varchar(100) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`number`),</span><br><span class="line">  UNIQUE KEY `unq_name` (`name`),</span><br><span class="line">  KEY `idx_country` (`country`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>

<p>隔离级别为RR:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &apos;%ISOLATION%&apos;;</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">| Variable_name         | Value           |</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">| transaction_isolation | REPEATABLE-READ |</span><br><span class="line">| tx_isolation          | REPEATABLE-READ |</span><br><span class="line">+-----------------------+-----------------+</span><br></pre></td></tr></table></figure>

<p>这个是表数据:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from hero;</span><br><span class="line">+--------+---------+---------+</span><br><span class="line">| number | name    | country |</span><br><span class="line">+--------+---------+---------+</span><br><span class="line">|      1 | w王朗   | 蜀      |</span><br><span class="line">|      3 | z诸葛亮 | 蜀      |</span><br><span class="line">|      8 | c曹操   | 魏      |</span><br><span class="line">|     15 | x荀彧   | 魏      |</span><br><span class="line">|     20 | s孙权   | 吴      |</span><br><span class="line">|     21 | 1qwe    | 吴      |</span><br><span class="line">|     22 | 2asfas  | 吴      |</span><br><span class="line">+--------+---------+---------+</span><br></pre></td></tr></table></figure>

<p>做一个unq_name的死锁:</p>
<p><img src="/2019/09/17/mysql死锁日志/t1.png" alt></p>
<p><img src="/2019/09/17/mysql死锁日志/t2.png" alt="t2"></p>
<p>执行顺序为A B C D,可以看到在T2进行insert操作时发生了死锁,到底怎么回事?</p>
<h6 id="查看死锁日志"><a href="#查看死锁日志" class="headerlink" title="查看死锁日志"></a>查看死锁日志</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW ENGINE INNODB STATUS;</span><br></pre></td></tr></table></figure>

<p>解析日志结构:</p>
<h6 id="1-TRANSACTION"><a href="#1-TRANSACTION" class="headerlink" title="*** (1) TRANSACTION:"></a>*** (1) TRANSACTION:</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from hero force index (unq_name) where name &lt; &apos;3&apos; for update;</span><br><span class="line">delete from hero where number = 8;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">=====================================</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">03</span>:<span class="number">49</span>:<span class="number">12</span> <span class="number">0x1dd0</span> INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">... 一些log行为</span><br><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK   </span><br><span class="line">------------------------</span><br><span class="line"><span class="comment">// 时间      </span></span><br><span class="line"><span class="comment">// 操作系统为当前session分配的线程的线程id</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">17</span> <span class="number">03</span>:<span class="number">42</span>:<span class="number">51</span> <span class="number">0x276c</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">// 事务1</span></span><br><span class="line">*** (<span class="number">1</span>) TRANSACTION:    </span><br><span class="line"></span><br><span class="line"><span class="comment">// 事务id </span></span><br><span class="line"><span class="comment">// 事务进入ACTIVE状态持续19s    </span></span><br><span class="line"><span class="comment">// 正在进行的操作为starting index read</span></span><br><span class="line">TRANSACTION <span class="number">98846</span>, ACTIVE <span class="number">19</span> sec starting index read </span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用了1张表,有1张表上包含锁</span></span><br><span class="line">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 事务进入LOCK WAIT状态</span></span><br><span class="line"><span class="comment">// 表上带有4个锁结构 (1个X型表级意向锁, 3个next锁:1qwe 2asfas c曹操) ----待定:c曹操是S锁,8没有锁</span></span><br><span class="line"><span class="comment">// 6个行级锁:大概是把next拆成了正经记录锁+gap锁</span></span><br><span class="line"><span class="comment">//    也可能是3个聚簇索引,3个唯一索引</span></span><br><span class="line">LOCK WAIT <span class="number">4</span> <span class="function">lock <span class="title">struct</span><span class="params">(s)</span>, heap size 1080, 6 row <span class="title">lock</span><span class="params">(s)</span></span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function"><span class="comment">// 本事务所在线程的id是5（MySQL自己命名的线程id），该线程在操作系统级别的id是7632</span></span></span><br><span class="line"><span class="function"><span class="comment">// 当前查询的id为403（MySQL内部使用，可以忽略），主机信息为 ::1 </span></span></span><br><span class="line"><span class="function">MySQL thread id 5, OS thread handle 7632, query id 403 localhost ::1 root updating</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 本事务发生阻塞的语句</span></span></span><br><span class="line"><span class="function">delete from hero where number </span>= <span class="number">8</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 本事务当前在等待获取的锁    </span></span><br><span class="line">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line"><span class="comment">// 等待获取的表空间ID为101，页号为3，也就是表hero的PRIMAY索引中的某条记录的锁</span></span><br><span class="line"><span class="comment">// n_bits为80, 这个就不解析了</span></span><br><span class="line"><span class="comment">// 该锁的类型是X型正经记录锁（rec but not gap）</span></span><br><span class="line">RECORD LOCKS space id <span class="number">101</span> page no <span class="number">3</span> n bits <span class="number">80</span> index PRIMARY of table `db1`.`hero` trx id <span class="number">98846</span> lock_mode X locks rec but not gap waiting</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该记录在页面中的heap_no为4，具体的记录信息如下：</span></span><br><span class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">5</span>; compact format; info bits <span class="number">0</span></span><br><span class="line">    <span class="comment">//  0:id 1:trx_id 2:roll_pointer 3:name 4:country</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">80000008</span>; asc     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000005</span>b11; asc     [ ;;</span><br><span class="line"> 2: len 7; hex af00000123012c; asc     # ,;;</span><br><span class="line"> <span class="number">3</span>: len <span class="number">7</span>; hex <span class="number">63e69</span>bb9e6938d; asc c      ;;</span><br><span class="line"> <span class="number">4</span>: len <span class="number">3</span>; hex e9ad8f; asc    ;;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>主要信息就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这个事务中表持有的锁    LOCK WAIT 4 lock struct(s), heap size 1080, 6 row lock(s)</span><br><span class="line">发生阻塞的语句  delete from hero where number = 8</span><br><span class="line">阻塞它的锁  index PRIMARY lock_mode X locks rec but not gap waiting</span><br><span class="line">0: len 4; hex 80000008; asc     ;;</span><br></pre></td></tr></table></figure>

<p>意思就是:<strong>这个事务要用到6个行锁,但是其中有一个没有获取到,他就是id为8(80000008)的记录</strong></p>
<h6 id="2-TRANSACTION"><a href="#2-TRANSACTION" class="headerlink" title="*** (2) TRANSACTION:"></a>*** (2) TRANSACTION:</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from hero where number = 8 for update;</span><br><span class="line">insert into hero values (27, &apos;2zzz&apos;, &apos;比三小&apos;);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">*** (<span class="number">2</span>) TRANSACTION:</span><br><span class="line">TRANSACTION <span class="number">98847</span>, ACTIVE <span class="number">15</span> sec inserting, thread declared inside InnoDB <span class="number">5000</span></span><br><span class="line">mysql tables in use <span class="number">1</span>, locked <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3个锁结构, 2个行锁, 1个undo log entries</span></span><br><span class="line"><span class="number">3</span> <span class="function">lock <span class="title">struct</span><span class="params">(s)</span>, heap size 1080, 2 row <span class="title">lock</span><span class="params">(s)</span>, undo log entries 1</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">MySQL thread id 6, OS thread handle 10092, query id 407 localhost ::1 root update</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">insert into hero <span class="title">values</span> <span class="params">(<span class="number">27</span>, <span class="string">'2zzz'</span>, <span class="string">'比三小'</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 事务2持有的锁:index PRIMARY</span></span></span><br><span class="line"><span class="function">*** <span class="params">(<span class="number">2</span>)</span> HOLDS THE <span class="title">LOCK</span><span class="params">(S)</span>:</span></span><br><span class="line"><span class="function">RECORD LOCKS space id 101 page no 3 n bits 80 index PRIMARY of table `db1`.`hero` trx id 98847 lock_mode X locks rec but not gap</span></span><br><span class="line"><span class="function">Record lock, heap no 4 PHYSICAL RECORD: n_fields 5</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">80000008</span>; asc     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000005</span>b11; asc     [ ;;</span><br><span class="line"> 2: len 7; hex af00000123012c; asc     # ,;;</span><br><span class="line"> <span class="number">3</span>: len <span class="number">7</span>; hex <span class="number">63e69</span>bb9e6938d; asc c      ;;</span><br><span class="line"> <span class="number">4</span>: len <span class="number">3</span>; hex e9ad8f; asc    ;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 阻塞事务2的锁:index unq_name, 插入意向锁, 63e69bb9e6938d</span></span><br><span class="line">*** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id <span class="number">101</span> page no <span class="number">4</span> n bits <span class="number">80</span> index unq_name of table `db1`.`hero` trx id <span class="number">98847</span> lock_mode X locks gap before rec insert intention waiting</span><br><span class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">7</span>; hex <span class="number">63e69</span>bb9e6938d; asc c      ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">4</span>; hex <span class="number">80000008</span>; asc     ;;</span><br></pre></td></tr></table></figure>

<p>主要信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insert into hero values (27, &apos;2zzz&apos;, &apos;比三小&apos;)</span><br><span class="line">index unq_name</span><br><span class="line">lock_mode X locks gap before rec insert intention waiting</span><br><span class="line"> 0: len 7; hex 63e69bb9e6938d; asc c      ;;</span><br><span class="line"> 1: len 4; hex 80000008; asc     ;;</span><br></pre></td></tr></table></figure>

<p>意思就是:<strong>事务1需要的锁在事务2这里呢,但是事务2也被阻塞了,被name=’c曹操’前边的gap锁阻塞</strong>(事务1干的)</p>
<h6 id="WE-ROLL-BACK-TRANSACTION-2"><a href="#WE-ROLL-BACK-TRANSACTION-2" class="headerlink" title="*** WE ROLL BACK TRANSACTION (2)"></a>*** WE ROLL BACK TRANSACTION (2)</h6><p>后来,我们回滚了事务2,让事务1执行下去</p>
<h5 id="问题出在哪"><a href="#问题出在哪" class="headerlink" title="问题出在哪?"></a>问题出在哪?</h5><p>死锁日志最显眼的就是那两条sql:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">T1:delete from hero where number = 8</span><br><span class="line">T2:insert into hero values (27, &apos;2zzz&apos;, &apos;比三小&apos;)</span><br></pre></td></tr></table></figure>

<p><strong>优先寻找这两条sql所在的事务,重点查看事务内这两个sql前面的sql</strong>,看看他们和T2 T1的问题sql之间有没有共用锁</p>
<p>然后查看T2等待的锁对应的记录是谁,进一步定位问题</p>
<p>回过头来,分析群里边的问题就由头绪了:</p>
<p>T1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UPDATE t_wating_shop</span><br><span class="line">		SET `status` = 0</span><br><span class="line">		 </span><br><span class="line">		 ,is_lack = 0</span><br><span class="line">		 </span><br><span class="line">	    WHERE user_id = 604 AND shop_id = 21228 AND ymd = &apos;2019-09-16&apos;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">index `idx_ymd` of table `vvic-pms`.`t_wating_shop` trx id 4777818 lock_mode X locks rec but not gap waiting</span><br><span class="line">Record lock, heap no 220 PHYSICAL RECORD: n_fields 2; compact format; info bits 0</span><br><span class="line"> 0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line"> 1: len 8; hex 800000000018498a; asc       I ;;</span><br></pre></td></tr></table></figure>

<p>T2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">UPDATE t_wating_shop</span><br><span class="line">		SET `status` = 0</span><br><span class="line">		WHERE</span><br><span class="line">			user_id = 753</span><br><span class="line">			AND ymd = &apos;2019-09-16&apos;</span><br><span class="line">			AND shop_id IN (</span><br><span class="line">				SELECT</span><br><span class="line">					shop_id</span><br><span class="line">				FROM</span><br><span class="line">					t_bill</span><br><span class="line">				WHERE</span><br><span class="line">					batch_id IN </span><br><span class="line">					 (    </span><br><span class="line">				  		1568596310045  </span><br><span class="line">					 ,   </span><br><span class="line">				  		1568602984074  </span><br><span class="line">					 ,   </span><br><span class="line">				  		1568603935432  </span><br><span class="line">					 ,   </span><br><span class="line">				  		1568614766375  </span><br><span class="line">					 ) </span><br><span class="line">			)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0: len 10; hex 323031392d30392d3136; asc 2019-09-16;;</span><br><span class="line">1: len 8; hex 8000000000184e78; asc       Nx;;</span><br></pre></td></tr></table></figure>

<p>T1中的ymd = ‘2019-09-16’被T2阻塞,T2的ymd = ‘2019-09-16’被T1阻塞,很有可能是S锁导致(单纯猜测),只需要看下T1上一条sql有没有hold Nx索引就行了</p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/09/11/mysql的一些命令/" rel="next" title="mysql的一些命令,容易忘记的">
                  <i class="fa fa-chevron-left"></i> mysql的一些命令,容易忘记的
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/09/27/端口号被占用/" rel="prev" title="端口号被占用">
                  端口号被占用 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#mysql死锁日志"><span class="nav-number">1.</span> <span class="nav-text">mysql死锁日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#故事背景"><span class="nav-number">1.1.</span> <span class="nav-text">故事背景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#要怎么看"><span class="nav-number">1.2.</span> <span class="nav-text">要怎么看</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#查看死锁日志"><span class="nav-number">1.2.1.</span> <span class="nav-text">查看死锁日志</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-TRANSACTION"><span class="nav-number">1.2.2.</span> <span class="nav-text">*** (1) TRANSACTION:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-TRANSACTION"><span class="nav-number">1.2.3.</span> <span class="nav-text">*** (2) TRANSACTION:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#WE-ROLL-BACK-TRANSACTION-2"><span class="nav-number">1.2.4.</span> <span class="nav-text">*** WE ROLL BACK TRANSACTION (2)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题出在哪"><span class="nav-number">1.3.</span> <span class="nav-text">问题出在哪?</span></a></li></ol></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Swen</p>
  <div class="site-description" itemprop="description">rain drop dida dida ~~~</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
        
      </div>
    
  </nav>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Swen</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.4.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>












        
      </div>
    </footer>
  </div>

  


  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.0"></script><script src="/js/motion.js?v=7.4.0"></script>
<script src="/js/schemes/pisces.js?v=7.4.0"></script>

<script src="/js/next-boot.js?v=7.4.0"></script>



  





















  

  

  

</body>
</html>
